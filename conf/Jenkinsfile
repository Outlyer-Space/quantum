pipeline {
    agent any

    // This pipeline will push repo changes on the local Outlyer server
    // dev.outlyer.space to GitHub at https://github.com/Outlyer-Space/quantum
    // the post receive hook script on the server will only
    // trigger this pipeline for "main" or "master" branches.

    // Access credentials
    environment {
        GITHUB_URL = 'github.com/Outlyer-Space/quantum.git'
        GITHUB_CRED = credentials('github-outlyercode')

        ACR_URL = 'outlyer.azurecr.io'
        ACR_NAME = 'outlyer'
        ACR_CRED = credentials('ACR_creds')

        AZ_APP = 'server-quantum'
        AZ_RGROUP ='outlyer-resources-usw'
    }

    stages {

        stage('Setup'){
            steps {
                echo "Starting build    ${env.BUILD_DISPLAY_NAME}"
                echo "cloning source to ${env.WORKSPACE}"
                echo "Building branch   ${env.GIT_LOCAL_BRANCH}"
                echo "Running as user/groups: "
                sh 'whoami;groups'
            }
        }

        stage('Test'){
            // Build & test latest code
            steps {
                echo 'Building docker image'
                sh 'docker build --pull -f docker/Dockerfile.azure -t quantum_azure:latest .'
                sh "docker tag quantum_azure:latest ${ACR_URL}/quantum:latest"

                echo 'Applying VERSION tag'
                sh """
                    TAG=\$(<VERSION tr -d '[:space:]')
                    docker tag quantum_azure:latest ${ACR_URL}/quantum:\${TAG}
                """
            }
        }

        stage('Deploy'){
            // Push to container registry & force server refresh
            // NOTE: if the "activeRevisionName" returns None, no app instance
            // is currently running (there's no demand).
            steps {
                echo 'Pushing to ACR'
                sh """
                    docker login ${ACR_URL} -u ${ACR_CRED_USR} -p ${ACR_CRED_PSW}
                    docker push ${ACR_URL}/quantum:latest

                    TAG=\$(<VERSION tr -d '[:space:]')
                    docker push ${ACR_URL}/quantum:\${TAG}
                """

                echo 'Forcing server refresh'
                sh """
                    az login \
                        --username ${ACR_CRED_USR} \
                        --password ${ACR_CRED_PSW}

                    az acr repository show-tags \
                        --name ${ACR_NAME} \
                        --repository quantum \
                        --output table

                    az containerapp update \
                        --resource-group ${AZ_RGROUP} \
                        --name ${AZ_APP} \
                        --image ${ACR_URL}/quantum:latest

                    az containerapp show \
                        --resource-group ${AZ_RGROUP} \
                        --name ${AZ_APP} \
                        --query "{revision:properties.activeRevisionName, image:properties.template.containers[0].image}" \
                        --output tsv
                """
            }
        }

        stage('Publish') {
            steps {
                echo 'Publishing changes to GitHub'

                // Add GitHub as second git remote
                sh """
                    git remote add github https://${GITHUB_CRED}@${GITHUB_URL}
                """

                // Push the current HEAD to the GitHub remote
                sh """
                    git push github HEAD:refs/heads/main
                """
            }
        }

        stage('Cleanup') {
            // delete workspace
            steps {
                echo 'Cleaning up workspace'
                // forcing immedeate directory removal to avoid "remote exists"
                // errors on successive pipeline runs in quick order
                cleanWs(
                    deleteDirs: true,
                    disableDeferredWipeout: true
                    )

                echo 'Removing docker images'
                // FIXME sh 'docker images -q | xargs -r docker rmi -f'
            }
        }
    }

}
