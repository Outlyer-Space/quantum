pipeline {
    agent any

    // Access credentials
    environment {
        GITHUB_CRED = credentials('github-outlyercode')
        GITHUB_URL = 'https://github.com/Outlyer-Space/quantum.git'
    }

    stages {

        stage('Setup'){
            steps {
                echo "Starting build ${env.BUILD_DISPLAY_NAME}"
                echo "cloning source to ${env.WORKSPACE}"
                echo "Building branch: ${env.GIT_LOCAL_BRANCH}"
            }
        }

        stage('Test'){
            // Validate changes
            steps {
                echo 'Validating new code'
            }
        }

        stage('Deploy'){
            // Deploy on Outlyer server
            steps {
                echo 'Deploying on production server'
            }
        }

        stage('Publish') {
            steps {
                // Add GitHub as second git remote
                sh """
                    git remote add ${GITHUB_REMOTE} ${GITHUB_URL}
                    git config credential.${GITHUB_URL}.username ${GITHUB_CRED_USR}
                """

                // Ensure local ref is up‑to‑date with origin/main
                sh '''
                    git fetch origin main
                    git reset --hard origin/main
                '''

                // Push the current HEAD to the GitHub remote
                sh """
                    git push ${env.GITHUB_REMOTE} HEAD:refs/heads/main
                """
            }
        }

        stage('Cleanup') {
            // delete workspace
            steps {
                echo 'Cleaning up workspace'
                cleanWs()
            }
        }
    }

}
